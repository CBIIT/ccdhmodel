# Regenerating the CRDC-H model

## Requirements
* __Python >= 3.7__
* __GNU make__ - Windows users can use [cygwin](https://www.cygwin.com/). `make` comes built into MacOS and most Linuxes.
* __pip__ - bundled with most python distros
* __virtualenv__ - can be installed by running `pip install virtualenv`
* __poetry__ - can be installed as per the instructions in [the Poetry docs](https://python-poetry.org/docs/#installation)

See also the LinkML model template's [original ABOUT.md](https://github.com/cancerDHC/ccdhmodel/blob/5ec6c203edd871a72c87aea03a894bbb3c798c79/from_template/ABOUT.md) file.

## The following is a reasonable start from a fresh repo

- `make generate-model` 
  - Requires some environment setup as described in [the README file](./README.md#automated-generation-of-yaml)
  - Recreates `model/schema/crdch_model.yaml` from the ["CDM_Dictionary_v1 (Active)" Google Sheet](https://docs.google.com/spreadsheets/d/1oWS7cao-fgz2MKWtyr8h2dEL9unX__0bJrWKv6mQmM4/edit#gid=1262189248) using `generators/google-sheets/sheet2linkml.py`
- `make`
  - Builds artifacts in `crdch_model` based on `model/schema/crdch_model.yaml` 
  - Also builds documentation in `docs` based on `model/schema/crdch_model.yaml` and `model/docs` 
  - Run this every time the model is modified, whether manually or via `make regen-google-sheets`
- `make test`
  - Minimal test input data in `tests/input/test_diagnosis.json`
  - Test script in `tests/test_input_against_model.py`
    - Like many other parts of this repo, would be regenerated by making the `from_template/MakeConfig`, which takes its configuration from `from_template/MakeConfig`
- `poetry run mike deploy dev -p`
  - Deploys generated documentation to GitHub Pages, replacing the `dev` version currently on this page
- git add, commit, push if desired

## Publishing to PyPI

You can publish this package to PyPI by running:

```
$ make pypi
```

This will run `poetry build` (to build the project into )

### Cleanup options

- `make clean`
  - Just cleans up `target`, which doesn't get synced anyway
    - `rm -rf target/*`

- `make squeaky-clean` (includes `make clean`)
  - Removes artifacts in the synced output directory `crdch_model`

## Using mike to maintain multiple versions

We use [mike](https://github.com/jimporter/mike) to maintain multiple
versions of our documentation on the website. We currently refer to
each version as e.g. `v0.2`. Please create Git tags to keep track of
which version of the source code the documentation was generated from.

To deploy a new version, you have to prepare the `docs/` directory
with the new documentation in Markdown. Usually, the steps described
above can be used to do this. However, if the `docs/` directory was not
created and populated correctly, you can run:

```
$ make clean      # This will delete the `docs/` directory. 
$ make gen-docs   # This will generate the docs in `target/docs`.
$ make stage-docs # This will copy `target/docs` into `docs/`.
```

Once the documentation has been generated in `docs/`, use mike to 
publish a new version:

```
$ poetry run mike deploy v0.2 latest -p
```

Note that the `-p` option causes mike to push the documentation to
the `gh-pages` branch immediately. `latest` is the alias we use to
indicate that a particular version should be considered the latest
(and therefore the default).
